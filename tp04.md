# TP 04 - Variables, types et locals
## Préparation

Dupliquer le projet TP03 dans le dossier tp_terraform et nommer le TP04

Dans le dossier TP04 :
 - Créer 1 nouveau fichier : variables.tf
 - Supprimer le répertoire .terraform et le fichier .terraform.lock.hcl
 - Modifier le bloc backend avec les bons paramètres (Note : le path sera terraform/state/TP04)
 - Faire un terraform init

## Objectif du tp

Il faut créer 3 containers docker qui vont contenir un petit serveur http écrit en language GO.
Nous allons compiler ce serveur directement en local afin que l'image soit la plus petite possible et utilise le moins de resource sur votre poste.
Afin de configurer les containers dockers, nous allons utiliser des variables, des locals avec différents types de données


## Création de l'image du serveur http en GO

Aller dans le repertoire materials/tp04_goapi/src/ de ce projet via git bash.

Executer la commande suivante pour construire l'image :

```shell
docker build -t goapi .
```

## Création de 3 resources de type docker_container avec utilisation de variables et de locals

Trouver la resource Terraform permettant de créer des containers docker sur le registry terraform

### Variables

Créer 3 objects qui vont contenir les infos concernant les containers docker

Ces 3 variables seront nommées :
- goapi01
- goapi02
- goapi03

Ces variables doivent contenir les clé suivantes :

- id (integer)
- env (string)
- is_master (boolean)
- ip (string)
- internal_port (integer)
- external_port (integer)

Voici le contenu a mettre pour chaque variable :

- goapi01 :
   - id = 1
   - env = "training"
   - ip  = "172.130.10.11"
   - is_master  = true
   - internal_port = 3000
   - external_port = 9011
- goapi02 :
    - id = 2
    - env = "training"
    - ip  = "172.130.10.12"
    - is_master  = true
    - internal_port = 3000
    - external_port = 9012
- goapi03 :
    - id = 3
    - env = "training"
    - ip  = "172.130.10.13"
    - is_master  = true
    - internal_port = 3000
    - external_port = 9013

### Resources

Créer 3 fois cette resource et completer les case <A COMPLETER> :

Le champ name doit être une concatenation du "GOAPI"-<id>-<env>


```hcl
resource "docker_container" goapi0<A COMPLETER> {
  name  = "GOAPI-${<A COMPLETER>}"    #interpolation HCL ${var......}
  image = <A COMPLETER>

  ports {
    internal = <A COMPLETER> # Le port interne où Go écoute
    external = <A COMPLETER> # Le port accessible depuis son pc
  }

  env = [
    "ENV=<A COMPLETER>",
    "IS_MASTER=<A COMPLETER>",
    "CONTAINER_IP=<A COMPLETER>",
    "LISTEN_PORT=<A COMPLETER>"     # Le port interne où Go écoute
  ]

  networks_advanced {
    name          = <A COMPLETER>
    ipv4_address  = <A COMPLETER>
  }
}
```

Vérifier la validité de votre code avec 

```shell
terrafom validate
```

Si tout est ok, appliquer les changement avec les commandes terraform plan et apply 

Vérifier que les pages http://127.0.0.1:9011,http://127.0.0.1:9012,http://127.0.0.1:9013 existent.

### locals et transformation

Faire un refactor pour utiliser une local nommée "containers" qui va:
    - transformer les 3 objets en une seule map ou les clés seront goapi1, goapi2 et goapi3.

Afficher la map dans un output nommé : container_spec_summary 

Appliquer les changement avec les commandes terraform plan et apply 

Afficher les ouputs avec la commande :

```shell
terraform output -json
```

Est ce bien une map ?

### terraform.tfvars

Créer un nouveau fichier terraform.tfvars et définir des nouvelles valeurs pour :
- goapi01
- goapi02
- goapi03

Les nouvelle valeurs sont les suivantes: 

- goapi01 :
  - id = 1
  - env = "prod"
  - ip  = "172.130.10.21"
  - is_master  = true
  - internal_port = 3000
  - external_port = 9021
- goapi02 :
  - id = 2
  - env = "prod"
  - ip  = "172.130.10.22"
  - is_master  = true
  - internal_port = 3000
  - external_port = 9022
- goapi03 :
  - id = 3
  - env = "prod"
  - ip  = "172.130.10.33"
  - is_master  = true
  - internal_port = 3000
  - external_port = 9023



Appliquer les changement avec les commandes terraform plan et apply

Vérifier que les pages http://127.0.0.1:9021,http://127.0.0.1:9022,http://127.0.0.1:9023 existent.


Faire la commande "terraform destroy" en vue du prochain TP.


