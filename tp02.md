# TP 02 - Migration state file dans consul

## Objectif du tp

L'objectif de ce tp est de centraliser le fichier tfstate dans Consul

Pour cela il faudra :
+ installer un serveur consul dockérisé via terraform
+ configurer consul avec une policy et créer un token
* Puis modifier notre projet du TP01 pour pour utilisé consul en tant que backend. 

## Démarrer consul via terraform

```shell
cd materials/tp02_consul
terraform init
terraform plan
terraform apply
```

## Configurer un ACL consul et générer un token 

Via l'ihm consul http://localhost:8500/ui (token = votre-token-master-secret) :

Créer une nouvelle policy avec ce contenu et la nommer terraform : 

```hcl
session "" {
  policy = "write"
}

session_prefix "" {
  policy = "write"
}

key_prefix "terraform/state/" {
  policy = "write"
}

key_prefix "consul/acl/" {
  policy = "deny"
}

key_prefix "" {
  policy = "read"
}
```

Puis créer token associé à la policy terraform 

## création du backend consul dans le projet Terraform

Dupliquer le projet TP01 dans le dossier tp_terraform et nommer le TP02

Dans le dossier TP02, créer 1 nouveau fichier : 
   - backend.tf

Ajouter le bloc backend avec les bons paramètres (Note : le path sera terraform/state/TP02)

Appliquer les changement avec les commandes terraform init, plan et apply 

Vérifier que le state est bien dans Consul dans les Key/Value

Bravo ! Vous venez de déplacer le tfstate dans consul !

Faire les commandes suivantes: 

```shell
terraform state list
terraform state show <A COMPLETER>
```


